{{- if .Values.actions.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ .Release.Name }}-runner"
  labels:
    app: "{{ .Release.Name }}-runner"
spec:
  replicas: {{ .Values.actions.runner.replicas | default 1 }}
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: "{{ .Release.Name }}-runner"
  template:
    metadata:
      labels:
        app: "{{ .Release.Name }}-runner"
    spec:
      hostname: docker
      initContainers:
        - name: install-jq
          image: curlimages/curl:latest
          command:
            - sh
            - -c
            - |
              # Download static jq binary for Linux amd64
              curl -L -o /shared/jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64
              chmod +x /shared/jq
              # Verify it works
              /shared/jq --version || echo "Warning: jq download may have failed"
          volumeMounts:
            - name: shared-tools
              mountPath: /shared
      containers:
        - name: docker-in-docker
          image: "{{ .Values.actions.runner.dind.image.repository }}:{{ .Values.actions.runner.dind.image.tag }}"
          imagePullPolicy: "{{ .Values.actions.runner.dind.image.pullPolicy }}"
          env:
            - name: DOCKER_TLS_CERTDIR
              value: /certs
            - name: DOCKER_HOST
              value: docker-in-docker
          securityContext:
            privileged: true
          ports:
            - name: docker
              containerPort: 2376
              protocol: TCP
          volumeMounts:
            - name: docker-certs
              mountPath: /certs
        - name: "{{ .Release.Name }}-runner"
          image: "{{ .Values.actions.runner.image.repository }}:{{ .Values.actions.runner.image.tag }}"
          imagePullPolicy: "{{ .Values.actions.runner.image.pullPolicy }}"
          command:
            - /bin/sh
            - -c
            - |
              cd /data
              # Use jq from shared volume (installed by initContainer)
              export PATH="/shared:${PATH}"
              export LD_LIBRARY_PATH="/shared/lib:${LD_LIBRARY_PATH}"
              if ! /shared/jq --version >/dev/null 2>&1; then
                echo "Error: jq is not working (checking dependencies...)"
                ldd /shared/jq 2>&1 || true
                exit 1
              fi
              echo "jq is available at /shared/jq"
              # Wait for shared secret to be available
              while [ -z "${FORGEJO_RUNNER_SHARED_SECRET}" ]; do
                echo "Waiting for shared secret..."
                sleep 1
              done
              # Always ensure runner file exists and is up to date
              if [ ! -f .runner ]; then
                echo "Creating runner file..."
                forgejo-runner create-runner-file \
                  --connect \
                  --instance "https://{{ .Values.subdomain }}.{{ .Values.globals.domain }}" \
                  --name "{{ .Values.actions.runner.name | default "default" }}" \
                  --secret "${FORGEJO_RUNNER_SHARED_SECRET}" || {
                    echo "Failed to create runner file, will retry..."
                    sleep 5
                    exit 1
                  }
              fi
              # Always update labels to match configuration
              {{- if .Values.actions.runner.labels }}
              # Verify jq is available
              if ! command -v jq >/dev/null 2>&1; then
                echo "Error: jq is not available"
                exit 1
              fi
              LABELS_JSON='[{{- range $index, $label := .Values.actions.runner.labels }}{{- if $index }},{{- end }}"{{ $label }}"{{- end }}]'
              echo "Updating runner labels to match configuration..."
              echo "New labels: ${LABELS_JSON}"
              # Ensure .runner file exists and is readable
              if [ ! -f .runner ]; then
                echo "Error: .runner file does not exist"
                exit 1
              fi
              # Show current labels before update
              CURRENT_LABELS_BEFORE=$(jq -r '.labels // "null"' .runner 2>/dev/null || echo "error reading file")
              echo "Current labels before update: ${CURRENT_LABELS_BEFORE}"
              # Update labels
              if jq --argjson labels "${LABELS_JSON}" '.labels = $labels' .runner > .runner.tmp; then
                mv .runner.tmp .runner
                echo "Labels updated successfully"
                # Verify the update
                CURRENT_LABELS_AFTER=$(jq -r '.labels // "null"' .runner)
                echo "Current labels after update: ${CURRENT_LABELS_AFTER}"
              else
                echo "Error: Failed to update labels with jq"
                exit 1
              fi
              {{- end }}
              # Always copy config from ConfigMap to ensure it's up to date
              echo "Copying config from ConfigMap..."
              cp /config/config.yml config.yml || {
                echo "Warning: Failed to copy config from ConfigMap, generating default..."
                forgejo-runner generate-config > config.yml
              }
              # Wait for docker-in-docker TCP to be ready
              echo "Waiting for docker-in-docker to be ready..."
              while ! nc -z localhost 2376 2>/dev/null; do
                echo "Docker daemon not ready, waiting..."
                sleep 2
              done
              # Wait for TLS certificates to be available
              while [ ! -f /certs/client/ca.pem ]; do
                echo "Waiting for TLS certificates..."
                sleep 1
              done
              echo "Docker daemon and certificates ready"
              # Verify runner file exists before starting daemon
              if [ ! -f .runner ] || [ ! -w .runner ]; then
                echo "Error: .runner file is missing or not writable"
                exit 1
              fi
              # Run daemon
              echo "Starting runner daemon..."
              while : ; do
                forgejo-runner --config config.yml daemon || {
                  echo "Daemon exited, restarting in 5 seconds..."
                  sleep 5
                }
              done
          env:
            - name: FORGEJO_INSTANCE_URL
              value: "https://{{ .Values.subdomain }}.{{ .Values.globals.domain }}"
            - name: FORGEJO_RUNNER_NAME
              value: {{ .Values.actions.runner.name | default "default" | quote }}
            - name: FORGEJO_RUNNER_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-runner-secrets"
                  key: shared-secret
            - name: DOCKER_HOST
              value: tcp://localhost:2376
            - name: DOCKER_TLS_VERIFY
              value: "1"
            - name: DOCKER_CERT_PATH
              value: /certs/client
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
          volumeMounts:
            - name: runner-data
              mountPath: /data
            - name: docker-certs
              mountPath: /certs
            - name: runner-config
              mountPath: /config
              readOnly: true
            - name: shared-tools
              mountPath: /shared
      volumes:
        - name: runner-data
          persistentVolumeClaim:
            claimName: "{{ .Release.Name }}-runner-data"
        - name: docker-certs
          emptyDir: {}
        - name: shared-tools
          emptyDir: {}
        - name: runner-config
          configMap:
            name: "{{ .Release.Name }}-runner-config"
{{- end }}
