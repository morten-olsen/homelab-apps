image:
  repository: codeberg.org/forgejo/forgejo
  tag: 14@sha256:fa8ce5aba7c20e106c649e00da1f568e8f39c58f1706bcf4f6921f16aaf5ba48
  pullPolicy: IfNotPresent

subdomain: code

# Deployment configuration
deployment:
  strategy: Recreate
  replicas: 1
  revisionHistoryLimit: 2

# Container configuration - multiple ports
container:
  ports:
    - name: http
      port: 3000
      protocol: TCP
    - name: ssh
      port: 22
      protocol: TCP
  healthProbe:
    type: tcpSocket
    port: http # Use named port

# DNS configuration
dns:
  enabled: true
  type: A
  dnsClassRef:
    name: private-dns

# OIDC/Authentik configuration
oidc:
  enabled: true
  redirectUris:
    - "/user/oauth2/Authentik/callback"

# Database configuration
database:
  enabled: true

# Service configuration - multiple services
service:
  ports:
    - name: http
      port: 80
      targetPort: 3000
      protocol: TCP
      type: ClusterIP
    - name: ssh
      port: 2206
      targetPort: 22
      protocol: TCP
      type: LoadBalancer
      serviceName: ssh # Will be prefixed with release name: {release}-ssh

# Volume configuration
volumes:
  - name: data
    mountPath: /data
    persistentVolumeClaim: data

# Persistent volume claims
persistentVolumeClaims:
  - name: data
    size: 10Gi
    storageClassName: persistent

# VirtualService configuration
virtualService:
  enabled: true
  gateways:
    public: true
    private: true
  servicePort: 80 # Route to the http service port

# Environment variables
env:
  USER_UID: "1000"
  USER_GID: "1000"
  FORGEJO__server__SSH_DOMAIN:
    value: "ssh-{subdomain}.{domain}" # Will be templated: ssh-{subdomain}.{domain}
  FORGEJO__server__SSH_PORT: "2206"
  FORGEJO__service__REQUIRE_EXTERNAL_REGISTRATION_PASSWORD: "true"
  FORGEJO__service__ENABLE_PASSWORD_SIGNIN_FORM: "false"
  FORGEJO__service__DEFAULT_KEEP_EMAIL_PRIVATE: "true"
  FORGEJO__service__DEFAULT_USER_IS_RESTRICTED: "true"
  FORGEJO__service__DEFAULT_USER_VISIBILITY: "private"
  FORGEJO__service__DEFAULT_ORG_VISIBILITY: "private"
  FORGEJO__service__ALLOW_ONLY_EXTERNAL_REGISTRATION: "true"
  FORGEJO__other__SHOW_FOOTER_POWERED_BY: "false"
  FORGEJO__other__SHOW_FOOTER_TEMPLATE_LOAD_TIME: "false"
  FORGEJO__other__SHOW_FOOTER_VERSION: "false"
  FORGEJO__repository__ENABLE_PUSH_CREATE_USER: "true"
  FORGEJO__repository__ENABLE_PUSH_CREATE_ORG: "true"
  FORGEJO__openid__ENABLE_OPENID_SIGNIN: "false"
  FORGEJO__openid__ENABLE_OPENID_SIGNUP: "false"
  FORGEJO__database__DB_TYPE: postgres
  FORGEJO__database__DB_PORT: "5432"
  FORGEJO__database__NAME:
    valueFrom:
      secretKeyRef:
        name: "{release}-connection"
        key: database
  FORGEJO__database__HOST:
    valueFrom:
      secretKeyRef:
        name: "{release}-connection"
        key: host
  FORGEJO__database__USER:
    valueFrom:
      secretKeyRef:
        name: "{release}-connection"
        key: user
  FORGEJO__database__PASSWD:
    valueFrom:
      secretKeyRef:
        name: "{release}-connection"
        key: password
  # Actions configuration
  FORGEJO__actions__ENABLED: "true"
  FORGEJO__actions__ENABLED_FOR_REPOSITORIES: "true"
  FORGEJO__actions__ENABLED_FOR_DEFAULT_BRANCH: "true"
  FORGEJO__actions__SHARED_SECRET:
    valueFrom:
      secretKeyRef:
        name: "{release}-runner-secrets"
        key: shared-secret

# External Secrets configuration for Actions runner
externalSecrets:
  - name: "{release}-runner-secrets"
    passwords:
      - name: shared-secret
        length: 20
        allowRepeat: true
        noUpper: false
        encoding: hex
        secretKeys:
          - shared-secret

# Actions runner configuration
actions:
  enabled: true
  runner:
    image:
      repository: code.forgejo.org/forgejo/runner
      tag: "12.6.4@sha256:2b65f3ba4345026d66de34dc8eddabb7b0f64c0e14905193ae81746f2728caa0"
      pullPolicy: IfNotPresent
    dind:
      image:
        repository: code.forgejo.org/oci/docker
        tag: dind@sha256:8bcbad4b45f0bff9d3e809d85a7ac589390f0be8acbc526850c998c35c1243fd
        pullPolicy: IfNotPresent
    name: default
    replicas: 1
    storage:
      size: 10Gi
    labels:
      - "ubuntu-latest:docker://gitea/runner-images:ubuntu-latest-slim"
      - "ubuntu-slim-latest:docker://gitea/runner-images:ubuntu-latest-slim"
      - "ubuntu-full-latest:docker://gitea/runner-images:ubuntu-latest-full"
      - "docker-cli:docker://code.forgejo.org/oci/docker:cli"
      - "node-bookworm:docker://code.forgejo.org/oci/node:20-bookworm"
